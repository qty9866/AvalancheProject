# src/wrf/scheduler/run_wps.py
import os
import logging
import sys
from datetime import datetime
import os
import subprocess
from datetime import datetime, timedelta, timezone
import logging

# =============================
# æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–
# =============================
log_dir = "/home/projects/logs"
os.makedirs(log_dir, exist_ok=True)  # å¦‚æœç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º
log_path = os.path.join(log_dir, "run_wps.log")

# è®¾ç½®æ—¥å¿—æ ¼å¼ä¸è¾“å‡ºï¼ˆåŒæ—¶è¾“å‡ºåˆ°æ–‡ä»¶å’Œæ§åˆ¶å°ï¼‰
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s",
    handlers=[
        logging.FileHandler(log_path, mode='a'),     # è¾“å‡ºåˆ°æ–‡ä»¶
        # logging.StreamHandler(sys.stdout)            # è¾“å‡ºåˆ°ç»ˆç«¯
    ]
)
logger = logging.getLogger(__name__)  # è·å–æ—¥å¿—å®ä¾‹

# =============================
# ç›®å½•ä¸æ–‡ä»¶è·¯å¾„é…ç½®
# =============================
WPS_DIR = "/WRF/Product_WRF/WPS"                     # WPS ç¨‹åºç›®å½•
GFS_DIR = "/WRF/Product_WRF/GFS_DATA"                # GFS æ•°æ®ç›®å½•
NAMELIST_PATH = os.path.join(WPS_DIR, "namelist.wps")  # namelist.wps æ–‡ä»¶è·¯å¾„


# =============================
# å·¥å…·å‡½æ•°ï¼šè¿è¡Œ Shell å‘½ä»¤
# =============================
def run_shell(cmd, cwd=None):
    """
    æ‰§è¡Œä¸€ä¸ª shell å‘½ä»¤ï¼ˆå¯é€‰æŒ‡å®šå·¥ä½œç›®å½•ï¼‰ï¼Œå¹¶æ•è·æ—¥å¿—ä¸å¼‚å¸¸ã€‚
    """
    logger.info(f"â–¶ï¸ æ‰§è¡Œå‘½ä»¤: {cmd}")
    result = subprocess.run(cmd, shell=True, cwd=cwd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)

    if result.returncode != 0:
        logger.error(f"âŒ å‘½ä»¤å¤±è´¥: {cmd}")
        logger.error(result.stderr)
        raise RuntimeError(f"å‘½ä»¤æ‰§è¡Œå¤±è´¥: {cmd}")
    else:
        logger.info(result.stdout)


# =============================
# æ­¥éª¤1ï¼šæ¸…ç†æ—§çš„ WPS æ–‡ä»¶
# =============================
def clean_wps_directory():
    """
    åˆ é™¤ WPS ç›®å½•ä¸­æ—§çš„ä¸­é—´æ–‡ä»¶ï¼Œä¿æŒç¯å¢ƒå¹²å‡€ã€‚
    """
    logger.info("ğŸ§¹ æ¸…ç†æ—§çš„ WPS æ–‡ä»¶...")
    patterns = [
        "GRIBFILE.AA*",
        "met_em.d01.*",
        "geo_em.d01.nc",
        "FILE:202*"
    ]
    for pattern in patterns:
        run_shell(f"rm -f {pattern}", cwd=WPS_DIR)


# =============================
# æ­¥éª¤2ï¼šé“¾æ¥ GFS æ•°æ®
# =============================
def link_grib_files(forecast_date):
    """
    é“¾æ¥å½“å‰æ—¥æœŸçš„ GFS æ•°æ®ï¼Œè°ƒç”¨ link_grib.csh è„šæœ¬ã€‚
    """
    folder_name = f"gfs_{forecast_date}_00z"
    grib_path = os.path.join(GFS_DIR, folder_name, "gfs.t00z.pgrb2.0p25.f0*")
    link_script = "./link_grib.csh"
    run_shell(f"{link_script} {grib_path}", cwd=WPS_DIR)


# =============================
# æ­¥éª¤3ï¼šä¿®æ”¹ namelist.wps èµ·æ­¢æ—¶é—´
# =============================
def update_namelist(start_date, end_date):
    """
    ä¿®æ”¹ namelist.wps æ–‡ä»¶ä¸­çš„ start_date å’Œ end_date å­—æ®µã€‚
    """
    logger.info("ğŸ“ ä¿®æ”¹ namelist.wps ä¸­çš„èµ·æ­¢æ—¥æœŸ...")

    with open(NAMELIST_PATH, "r") as f:
        lines = f.readlines()

    def replace_line(key, new_value):
        """
        åœ¨ namelist.wps ä¸­æ‰¾åˆ° key å¼€å¤´çš„è¡Œï¼Œå¹¶æ›¿æ¢ä¸ºæ–°å€¼ã€‚
        """
        for i, line in enumerate(lines):
            if line.strip().startswith(key):
                lines[i] = f" {key} = '{new_value}'\n"
                return
        raise ValueError(f"{key} not found in namelist")

    replace_line("start_date", f"{start_date}_00:00:00")
    replace_line("end_date", f"{end_date}_00:00:00")

    with open(NAMELIST_PATH, "w") as f:
        f.writelines(lines)

    logger.info(f"âœ… namelist.wps å·²æ›´æ–°ä¸º {start_date} -> {end_date}")


# =============================
# æ­¥éª¤4ï¼šè¿è¡Œ WPS ä¸‰ä¸ªæ ¸å¿ƒç¨‹åº
# =============================
def run_wps_programs():
    """
    æ‰§è¡Œ WPS çš„ä¸‰ä¸ªé˜¶æ®µæ€§ç¨‹åºï¼šungrib, geogrid, metgridã€‚
    """
    logger.info("ğŸš€ å¼€å§‹æ‰§è¡Œ WPS ä¸‰ä¸ªç¨‹åº...")
    for exe in ["ungrib.exe", "geogrid.exe", "metgrid.exe"]:
        run_shell(f"./{exe}", cwd=WPS_DIR)


# =============================
# ä¸»æµç¨‹å‡½æ•°ï¼šè°ƒç”¨ä»¥ä¸Šæ­¥éª¤
# =============================
def run():
    """
    è°ƒç”¨å…¨æµç¨‹ï¼šæ¸…ç†ç›®å½• â†’ é“¾æ¥æ•°æ® â†’ ä¿®æ”¹å‚æ•°æ–‡ä»¶ â†’ æ‰§è¡Œç¨‹åºã€‚
    """
    logger.info("ğŸ å¼€å§‹ WPS æµç¨‹ä»»åŠ¡")
    # è®¾ç½® UTC+8 æ—¶åŒº
    CHINA_TZ = timezone(timedelta(hours=8))
    today = datetime.now(CHINA_TZ).date()
    forecast_date = today.strftime("%Y%m%d")         # ç”¨äºç›®å½•å
    start_date = today.strftime("%Y-%m-%d")           # namelist å¼€å§‹æ—¶é—´
    end_date = (today + timedelta(days=4)).strftime("%Y-%m-%d")  # ç»“æŸæ—¶é—´ï¼š+4 å¤©

    clean_wps_directory()
    link_grib_files(forecast_date)
    update_namelist(start_date, end_date)
    run_wps_programs()

    logger.info("ğŸ‰ WPS æµç¨‹å®Œæˆ")


# =============================
# å…¥å£å‡½æ•°
# =============================
if __name__ == "__main__":
    run()